

# D-Link Vulnerability

Vendor:D-Link

Product:DIR_882

Version:DIR_882_FW1.30B06_Hotfix_02(Download Link:https://support.dlink.com/productinfo.aspx?m=DIR-882-US)

Type:Command Execution

Author:Jiaqian Peng,Huizhao Wang

Institution:pengjiaqian@iie.ac.cn,wanghuizhao@iie.ac.cn



## Vulnerability description

We found an Command Injection vulnerability  in D-link Technology router with firmware which was released recently.A command Injection vulnerability allows attackers to execute arbitrary OS commands via a crafted /HNAP1 POST request. This occurs when any HNAP API function triggers a call to the `twsystem` function with untrusted input from the request body for the `SetUsersSettings` API function (ModuleInitUSB,need authentication).

**Command Execution**

`prog.cgi` binary:

In `SetUsersSettings` function,`Username`„ÄÅ`Password` is directly passed by the attacker.After that, call the function sub_4966B0.

<div  align="center"><img src="./images/1.png" style="zoom:80%;" /></div>

As you can see here, the input has not been checked.And then,call the function nvram_safe_set to store this input.

<div  align="center"><img src="./images/2.png" style="zoom:80%;" /></div>

`rc` binary:

<div  align="center"><img src="./images/3.png" style="zoom:80%;" /></div>

Eventually, the initial input will be extracted and cause command injection.

<div  align="center"><img src="./images/4.png" style="zoom:80%;" /></div>

**Supplement**

In order to avoid such problems, we believe that the string content should be checked in the input extraction part.**The key to triggering this vulnerability is to set up samba and ftp services, and be able to insert usb devices**.**(HID attack)**



## PoC

We set `Username` as **123123;telnetd -l /bin/sh -p 9999 -b 0.0.0.0;** , and the router will excute it,such as:

<div  align="center"><img src="./images/5.png" style="zoom:80%;" /></div>



## Result

This will triger the `start_samba` method, and then get a shell!

